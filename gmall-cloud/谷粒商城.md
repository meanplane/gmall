## docker

### 0 命令

```shell
docker images #查看所有镜像
docker image rm ** #删除镜像

docker ps -a #查看所有container
docker rm [containerID] #删除container
docker kill [containerID] #杀死container
docker stop [containerID] 
docker restart [containerID] 

docker container run -p 8000:3000 -it koa-demo /bin/bash
# -it参数:容器的shell映射到当前的shell,你再本机窗口输入的命令,会传入容器.
# -p参数:(-p 3308:3306)容器的 端口映射到本地的端口.

#进入容器
docker attach [containerID] #退出会导致容器终止
docker exec [containerID] #推荐, 退出不会导致容器终止

docker exec -it mysql /bin/bash


```





### 1 mysql

下载镜像: docker pull mysql:5.7

**创建实例并启动**

```shell
docker run -p 3308:3306 --name mysql \
-v /data/mysql/log:/var/log/mysql \
-v /data/mysql/data:/var/lib/mysql \
-v /data/mysql/conf:/etc/mysql \
-e MYSQL_ROOT_PASSWORD=root \
-d mysql:5.7
```

参数说明:

​	-p 3307:3306 将容器的3306 端口映射到主机的3306端口

​	-v /data/mysql/log:/var/log/mysql \  将配置文件夹挂载到主机

​	-v /data/mysql/data:/var/lib/mysql \ 将日志文件挂载到主机

​	-v /data/mysql/conf:/etc/mysql \		将配置文件夹挂载到主机

​	-e MYSQL_ROOT_PASSWORD=root \	初始化root用户的密码



### 2 redis

```shell
mkdir -p /data/redis/conf
touch /data/redis/conf/redis.conf

docker run -p 7001:6379 --name redis \
-v /data/redis/data:/data \
-v /data/redis/conf/redis.conf:/etc/redis/redis.conf \
-d redis redis-server /etc/redis/redis.conf

# 连接redis客户端
docker exec -it redis redis-cli
```



## 技术方案

**SpringCloudAlibaba**

+ Nacos : 注册中心 (服务发现 / 注册)
+ Nacos : 配置中心 (动态配置管理)
+ Ribbon : 负载均衡
+ Feign : 声明式HTTP客户端 (远程调用服务)
+ Sentinel : 服务容错 (限流 , 降级 , 熔断)
+ Gateway : API网关 (webflux 编程模式)
+ Sleuth : 调用链监控
+ Seata : (原 Fescar) 分布式事务解决方案



## nacos

### 注册中心

1. 下载nacos-server 启动 (端口8848)

2. 注册服务pom引入nacos discovery starter

   ```xml
   <dependency>
     <groupId>com.alibaba.cloud</groupId>
     <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
   </dependency>
   ```

3. 配置文件中配置 nacos server地址

   spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848

4. 使用@EnableDiscoveryClient 开启服务注册发现功能

5. 用feign测试服务调用



### 配置中心

1. 引入pom

   ```xml
   <dependency>
     <groupId>com.alibaba.cloud</groupId>
     <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
   </dependency>
   ```

2. resources下创建bootstrap.properties 配置文件 配置nacos config元数据

   ```properties
   spring.application.name=gmall-coupon
   spring.cloud.nacos.config.server-addr=127.0.0.1:8848
   ```

3. 完成上述两步后, 应用会从Nacos.config 中获取相应配置, 并添加在Spring Environment 的PropertySources中. 

   ```java
   @Value("${coupon.tom.name:xxx}")
   private String name;
   @Value("${coupon.tom.age:12}")
   private Integer age;
   
   ```

4. 命名空间

   在bootstrap.properties中配置 spring.cloud.nacos.config.namespace=xxxx区别

5. 配置组

   spring.cloud.nacos.config.group=xxx

## Feign

`声明式远程调用`

> Feign 是一个声明式的HTTP客户端. Feign提供了HTTP请求的模板, 通过编写简单的接口和插入注解, 就可定义好HTTP请求的参数, 格式, 地址 等 信息.
>
> Feign 整合了 Ribbon(负载均衡) 和 Hystrix(服务熔断), 可以让我们不再需要显示的使用这2个组件.
>
> SpringCloudFeign 在NetflixFeign 的基础上扩展了 对 SpringMVC注解的支持, 在其实现下, 我们只需创建一个接口并用注解的方式来配置它, 即可完成服务提供方的接口绑定. 简化了SpringCloudRibbon自行封装服务调用客户端的开发量.

1. pom引入

   ```xml
   <dependency>
     <groupId>org.springframework.cloud</groupId>
     <artifactId>spring-cloud-starter-openfeign</artifactId>
   </dependency>
   ```

2. App开启标签 @EnableFeignClients

3. 定义调用接口

   ```java
   @FeignClient("gmall-coupon")
   public interface CouponFeignService {
       @RequestMapping("/coupon/coupon/member/list")
       public R membercoupons();
   }
   ```

4. 使用

   ```java
   @Autowired
   CouponFeignService couponFeignService;
   
   R membercoupons = couponFeignService.membercoupons();
   ```

## Gateway

> 网关作为流量的入口,常用功能包括路由转发,权限校验,限流控制 等, 而springcloud gateway 作为springcloud官方推出的第二代网关框架, 取代了zuul

1. 引入pom

   ```xml
   ## gateway 是使用netty + webflux 实现,因此不需要引入web模块
   <dependency>
     <groupId>org.springframework.cloud</groupId>
     <artifactId>spring-cloud-starter-gateway</artifactId>
   </dependency>
   ```

2. 配置文件

   ```yaml
   spring:
     application:
       name: gmall-gateway
     cloud:
       nacos:
         discovery:
           server-addr: mplane.cn:8848
       gateway:
         routes:
           - id: test_route
             uri: https://www.baidu.com
             predicates:
               - Query=url,baidu
           - id: qq_route
             uri: https://www.qq.com
             predicates:
               - Query=url,qq
   ```

   id : 自定义路由id

   uri : 目标服务地址

   predicates : 路由条件

3. 